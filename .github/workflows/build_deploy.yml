name: Build & Deploy

on:
  push:
    branches: [ staging ]

jobs:
  build_deploy:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        DISTRIBUTION: ["DISTRIBUTION_0", "DISTRIBUTION_1"]

    env: 
      GH_TOKEN: ${{secrets.GH_TOKEN}}
      DISTRIBUTION: ${{secrets[matrix.DISTRIBUTION]}}
      COMMIT_SHA: ${GITHUB_SHA}
      BRANCH_NAME: ${GITHUB_REF##*/}

    steps:
      - name: Print GITHUB_REF
        run: echo "$GITHUB_REF"

      - name: Print BRANCH_NAME
        run: echo "$BRANCH_NAME"
        
      - name: Set TAG environment variable
        run: echo "::set-env name=TAG::$(git tag --points-at HEAD)"
        
      - name: Checkout
        uses: actions/checkout@v2

      - name: Yarn cache
        uses: c-hive/gha-yarn-cache@v1

      - name: Authenticate git clone
        run: echo -e "machine github.com\n  login ${GH_TOKEN}" > ~/.netrc

      - name: Install JS dependencies
        run: yarn --frozen-lockfile

      - name: Test
        run: yarn test
  
      - name: Create commit file ${COMMIT_SHA}
        run: echo -e "$COMMIT_SHA" > "${GITHUB_WORKSPACE}/dist/commit"
        
      - name: Build & push Docker image
        run: |
          if [ "$BRANCH_NAME" == "staging" ]; then
            yarn bundle:staging
            if [ "$DISTRIBUTION" == "wire" ]; then
              yarn docker '' staging
            else
              yarn docker "$DISTRIBUTION" staging
            fi
          else if [ "$BRANCH_NAME" == "master" && -n "$TAG" ]; then
            yarn bundle:prod
            if [ "$DISTRIBUTION" == "wire" ]; then
              yarn docker '' production
            else
              yarn docker "$DISTRIBUTION" production
            fi
          fi

        
        
